//
// Project: Mix Mode
// File Name: MixMode.cfg
// Date: 2016
// Author: BudSpencer
//
// Purpose: Mix Module - Start + Manage a mix
//


defmap = "complex"
defmode = 0
delay = 5 // 5 seconds resume countdown
isEnabled = 0
isIntermission = 0
min_players_for_mix = 4
isMixRound = 0
isIdleRound = 0
isFirstRound = 0
mix_ = 0

Unregister_Commands = [ unrgistercommand "mixstart" ; unregistercommand "mixpause" ; unregistercommand "mixrestart" ; unregistercommand "mixstop" ]
start_countdown = [ say ( format "^f7Game will start in ^f3%1 ^f7seconds, prepare ^f4yourself^f7." $delay ) ; asleep ( * $delay 1000 ) [ say ( format "^f7Game is ^f3resumed^f7. ^f4Have Fun^f7!" ) ; pause 0 ] ; loop n ( - $delay 1 ) [ asleep ( * ( + $n 1 ) 1000 ) [ say ( format "^f7Starting in ^f3%1 ^f7seconds ..." ( - $delay ( + @n 1 ) ) ) ] ] ]
restart_countdown = [ say ( format "^f7Restarting game in ^f3%1 ^f7seconds, prepare ^f4yourself^f7." $delay ) ; asleep ( * $delay 1000 ) [ say ( format "^f7Restarting ^f3mix^f7. Map: ^f4%1 ^f7/ Mode: ^f4%2^f7.^f4Have Fun^f7!" ( getmap ) ( modetostr ( getmode ) ) ) ; mapmode ( getmap ) ( getmode ) ] ; loop n ( - $delay 1 ) [ asleep ( * ( + $n 1 ) 1000 ) [ say ( format "^f7Restarting in ^f3%1 ^f7seconds ..." ( - $delay ( + @n 1 ) ) ) ] ] ]

// imported from scripts/modules/DuelMode.cfg
pause_if_somebody_leave_ = [ if ( = $isEnabled 1 ) [ if ( != ( isspectator $arg1 ) 1 ) [ pause 1 ; say ( format "Player ^f3%1(%2) ^f7is disconnected^f7. Maybe he ^f4ragequit^f7. We'll wait until he come ^f4back^f7." ( getname $arg1 ) $arg1 ) ] ] ]
pause_if_somebody_spec_ = [ if ( = $isEnabled 1 ) [ if ( != ( isspectator $arg1 ) 0 ) [ pause 1 ; say ( format "Player ^f3%1(%2) ^f7is spectated^f7. Unspectate him and ^f4resume(type: #mixpause 0) ^f7mix." ( getname $arg1 ) $arg1 ) ] ] ]

Command_mixpause = [
	case $arg2 1 [
		pause 1 
		say ( format "Mix is ^f3paused^f7. Stay ^f4ready^f7!" )
	] 0 [ 
		say ( format "^f7Game will continue in ^f3%1 ^f7seconds, prepare ^f4yourself^f7." $delay ) ; asleep ( * $delay 1000 ) [ say ( format "^f7Game is ^f3resumed^f7. ^f4Have Fun^f7!" ) ; pause 0 ] ; loop n ( - $delay 1 ) [ asleep ( * ( + $n 1 ) 1000 ) [ say ( format "^f7Continue in ^f3%1 ^f7seconds ..." ( - $delay ( + @n 1 ) ) ) ] ]
	]
]

Command_mixstop = [ Unregister_Commands ; mapmode $defmap $defmode ; say ( format "Mix has ^f3ended^f7! Thank you for using my ^f4module^f7! Credits: Programming + Idea: ^f4/BudSpencer^f7" ) ; isEnabled = 0 ; isMixRound = 0 ; isIdleRound = 0 ]
Command_mixstart = [ isMixRound = 1 ; isIdleRound = 0 ; mapmode $arg3 ( indexof $MODENAMES $arg2 ) ; start_countdown ]
Command_mixrestart = [ isMixRound = 1 ; isIdleRound = 0 ; restart_countdown ]

cmd_mix = [
	//if ( >= ( listlen ( allactiveplayers ) ) $min_players_for_mix ) [
		if ( = $isEnabled 0 ) [	
			// register some mix-important commands
			registercommand "mixpause" Command_mixpause 2 "b" "mixpause ^f3This command allows you to pause/resume the mix."
			registercommand "mixstop" Command_mixstop 3 "" "mixstop ^f3This command allows you to quit the mix."
			registercommand "mixstart" Command_mixstart 2 "ww" "mixstart <mode> <map> ^f3This command allows you to start a new round."
			registercommand "mixrestart" Command_mixrestart 3 "" "This command allows you to restart the mix. Map and Mode will set to current one."
			mastermode 2 ; persist 1 ; isEnabled = 1 ; isFirstRound = 1 ; isIdleRound = 0 ; isMixRound = 1 ; mapmode $arg3 ( indexof $MODENAMES $arg2 ) ; pause 1 ; asleep 1000 [ say ( format "Player ^f3%1(%2) ^f7started a mix on map ^f3%3^f7. Mode is ^f4%4^f7." ( getname $arg1 ) $arg1 ( getmap ) ( modetostr ( getmode ) ) ) ; start_countdown ]
		] [
			pm $arg1 ( format "You can't start a new ^f3mix ^f7if it's currently running! Use ^f4#mixstop ^f7to stop mix and try again!" )
		]
	//] [
		//pm $arg1 ( format "Here aren't enough players for a ^f3mix^f7. You need at least ^f4%1 ^f7players." $min_players_for_mix )
	//]
]

IdleOrMix = [
	if ( = $isMixRound 1 ) [ isIdleRound = 0 ]
	if ( = $isMixRound 0 ) [ isIdleRound = 1 ]
]

OnIntermission = [ if ( = $isFirstRound 1 ) [ isFirstRound = 0 ] [ if ( = $isIdleRound 1 ) [ mix_ = 0 ] [ if ( = $isMixRound 1 ) [ isMixRound = 0 ; isIdleRound = 1 ; asleep 5000 [ say ( format "^f7Mix round has ^f3ended^f7. Masters and Admins can start a new mix round by typing ^f4#mixstart <mode> <map>^f7. This round is a ^f4break^f7. Have fun!" ) ] ] [ isMixRound = 1 ; isIdleRound = 0 ] ] ] ]

// register event handlers
addhandler "onmapstart" IdleOrMix
addhandler "ondisconnect" pause_if_somebody_leave_
addhandler "onspectator" pause_if_somebody_spec_
addhandler "onimission" OnIntermission
// register mix-start command
registercommand "mix" cmd_mix 2 "ww" "mix <mode> <map> ^f3This command allows you to initiate a mix. Just execute this before the first round."






	