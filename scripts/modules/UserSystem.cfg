// advanced IP-Adress based user login system - player can claim master/admin if registered by host
// made by /BudSpencer ( 2016 ) 


// main values
defaultvalue "enable_user_system_master" 1
defaultvalue "enable_user_system_admin" 1


cmd_admin = [

 ip = ( getip $arg1 )
 
if ( = $enable_user_system_admin 1 ) [
	
	ip = ( getip $arg1 )
	
if ( = ( isoverflow ( getip $arg1 ) ) 1 ) [

	pm $arg1 ( format "^f7Your ^f3IP-Adress ^f7is ^f4overflown ^f7from ^f4user system^f7." )
	
	] [
	
if ( = ( isblockedadmin ( getip $arg1 ) ) 1 ) [

	pm $arg1 ( format "^f7Your ^f3IP-Adress ^f7is ^f4blocked ^f7on that ^f4server^f7. You can't claim ^f4Admin ^f7here." )
	
	] [
	
	ip = ( getip $arg1 )
	
if ( = ( isregadmin ( getip $arg1 ) ) 1 ) [

isin = ( getvar $arg1 isloggedin )

if ( = ( getvar $arg1 isloggedin ) 0 ) [

	setpriv $arg1 3 
	
	pname = ( getname $arg1 )
	pcn = ( getcn $arg1 )
	
	say ( format "^f7Player ^f3%1(%2) ^f7is authentificated as ^f4Local Admin^f7. (Username: ^f4%1^f7) [^f7Server: ^f4%3^f7]" $pname $pcn $servershortname )
	setvar $arg1 isloggedin 1
	
	] [
	
	pm $arg1 ( format "^f7You are already ^f3logged in^f7. Please ^f4logout ^f7and try again." )
					
						]
					
					] [
					
					pm $arg1 ( format "^f7Cannot ^f3authentificate ^f7your IP-Adress as ^f4registered admin^f7." )
				
				]
			
			]
		
		] [
		
		pm $arg1 ( format "^f7User Login System is ^f3disabled ^f7on that ^f4server^f7." )
		
		]
		
	]
	
]








cmd_master = [

 ip = ( getip $arg1 )
 
if ( = $enable_user_system_admin 1 ) [
	
	ip = ( getip $arg1 )

if ( = ( isoverflow ( getip $arg1 ) ) 1 ) [

	pm $arg1 ( format "^f7Your ^f3IP-Adress ^f7is ^f4overflown ^f7from ^f4user system^f7." )
	
	] [
	
if ( = ( isblockedmaster ( getip $arg1 ) ) 1 ) [

	pm $arg1 ( format "^f7Your ^f3IP-Adress ^f7is ^f4blocked ^f7on that ^f4server^f7. You can't claim ^f4master ^f7here." )
	
	] [
	
	ip = ( getip $arg1 )
	
if ( = ( isregmaster ( getip $arg1 ) ) 1 ) [

if ( = ( getvar $arg1 isloggedinm ) 0 ) [

	setpriv $arg1 2 
	
	pname = ( getname $arg1 )
	pcn = ( getcn $arg1 )
	
	say ( format "^f7Player ^f3%1(%2) ^f7is authentificated as ^f4Local Master^f7. (Username: ^f4%1^f7) [^f7Server: ^f4%3^f7]" $pname $pcn $servershortname )
	setvar $arg1 isloggedinm 1
	
	] [
	
	pm $arg1 ( format "^f7You are already ^f3logged in^f7. Please ^f4logout ^f7and try again." )
					
						]
					
					] [
					
					pm $arg1 ( format "^f7Cannot ^f3authentificate ^f7your IP-Adress as ^f4registered master^f7." )
				
				]
			
			]
		
		] [
		
		pm $arg1 ( format "^f7User Login System is ^f3disabled ^f7on that ^f4server^f7." )
	
		]
	
	]
	
]








cmd_logout_direct = [

	if ( = ( getvar $arg1 isloggedin ) 1 ) [
	
	setvar $arg1 isloggedinm 0
	setvar $arg1 isloggedin 0
	setpriv $arg1 0
	
	say ( format "^f7Player ^f3%1(%2) ^f7successfully logged out from ^f4user system^f7." )
	
	]

]









setwars_login_connect = [

setvar $arg1 isloggedin 0
setvar $arg1 isloggedinm 0

]










cmd_logout = [

	if ( || ( = ( getvar $arg1 isloggedin ) 1 ) ( = ( getvar $arg1 isloggedinm ) 1 ) ) [
	
		if ( =s $arg2 "1" ) [
		
		pm $arg1 ( format "^f7You ^f3successfully ^f7logged out from ^f4user system^f7." ) 
		
		setvar $arg1 isloggedin 0
		setvar $arg1 isloggedinm 0
		setpriv $arg1 0
		
		] [
		
		pm $arg1 ( format "^f7Are you sure, that you wanna ^f3logout ^f7from ^f4user system^f7? If yes, type ^f4#logout 1 ^f7and your logged out." )
		
		]
	
	] [

	pm $arg1 ( format "^f7You are not ^f3logged in^f7. Please ^f4login ^f7and retry." ) 
	
	]
	
]








registered_player_msg = [

 ip = ( getip $arg1 )
 pname = ( getname $arg1 )
 pcn = ( getcn $arg1 )
 
	if ( = ( isoverflow $ip ) 1 ) [
	
	pm $pcn ( format "^f7Your ^f3IP-Adress ^f7is ^f4overflown ^f7from ^f4user system^f7. Maybe your ^f4IP-Adress ^f7is registered to ^f4both ^f7privileges^f7?" )
	
	] [
	
	if ( = ( isregadmin $ip ) 1 ) [
	
	pm $pcn ( format "^f7You are ^f3authentificated ^f7as ^f4registered user^f7. Type ^f4#admin ^f7to claim ^f4Local Admin^f7." )
	
	] [
	
	if ( = ( isregmaster $ip ) 1 ) [
	
	pm $pcn ( format "^f7You are ^f3authentificated ^f7as ^f4registered user^f7. Type ^f4#master ^f7to claim ^f4Local Master^f7." )
	
	] [
	
	if ( = ( isblocked $ip ) 1 ) [
	
	pm $pcn ( format "^f7Your ^f3IP-Adress ^f7is ^f4blocked ^f7on this ^f4Server^f7." )
				
				]
				
			]
			
		]
		
	]
	
]







	
cmd_isloggedin = [

	all = ( allplayers )
		looplist cn $all [
		
		if ( || ( = ( getvar $cn isloggedinm ) 1 ) ( = ( getvar $cn isloggedin ) 1 ) ) [
		
		pname = ( getname $cn )
		pcn = ( getcn $cn )
		
		pm $arg1 ( format "^f7Player ^f3%1(%2) ^f7is ^f4logged in ^f7as a ^f4Local %3^f7. (Username: ^f4%1^f7)" $pname $pcn ( getprivilege $cn ) )
		
		] [
		
		if ( && ( && ( = ( getvar $cn isloggedinm ) 0 ) ( = ( getvar $cn isloggedin ) 0 ) ) ( || ( = ( isregmaster ( getip $cn ) ) 1 ) ( = ( isregmaster ( getip $cn ) ) 1 ) ) ) [
		
		pname = ( getname $cn )
		pcn = ( getcn $cn )
		
		pm $arg1 ( format "^f7Player ^f3%1(%2) ^f7is ^f4logged out^f7." $pname $pcn )
			
			] [
			
			pname = ( getname $cn )
			pcn = ( getcn $cn )
		
			pm $arg1 ( format "^f7Player ^f3%1(%2) ^f7is ^f4not a registered^f7 player." $pname $pcn )
			
			]
			
		] 
		
	]
	
]



addhandler "onconnect" setwars_login_connect
addhandler "onconnect" registered_player_msg
addhandler "ondisconnect" cmd_logout_direct

registercommand "master" cmd_master 1 "" "master ^f4This command gives a registered user master privileges."
registercommand "admin" cmd_admin 1 "" "admin ^f4This command gives a registered user admin privileges."
registercommand "logout" cmd_logout 2 "|i" "logout ^f4This command logouts you from User System."
registercommand "logstate" cmd_isloggedin 1 "" "logstate ^f4This command checks login status of all players and return it."
		
		





	